{% extends 'base.html' %}
{% load static %}

{% block title %}
Pr√©inscription - {{ home_data.site_name }}
{% endblock %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body {
    background: #f4f6f9;
  }

  .header {
    text-align: center;
    margin-bottom: 40px;
  }

  .header img {
    max-height: 90px;
    margin-bottom: 15px;
  }

  .header h1 {
    font-weight: 700;
    color: #0d6efd;
  }

  .card-form {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    padding: 40px;
  }

  .form-control {
    border-radius: 10px;
  }

  .btn {
    border-radius: 8px;
    font-weight: 600;
  }

  .modal-content {
    border-radius: 15px;
  }
</style>

<div class="container py-5">

  <div class="header">
    <img src="{% static 'images/logo.png' %}" alt="Logo">
    <h1>Pr√©inscription en ligne</h1>
    <p class="text-muted">{{ home_data.site_name }}</p>
  </div>

  <div class="text-center mb-4">
    <a href="{% url 'home' %}" class="btn btn-secondary">
      ‚Üê Retour √† l‚Äôaccueil
    </a>
  </div>

  <div class="card-form">
    <form id="preinscriptionForm" method="POST" onsubmit="showRecapModal(event)">
      {% csrf_token %}

      <div class="row mb-3">
        <div class="col-md-6">{{ form.nom.label_tag }} {{ form.nom }}</div>
        <div class="col-md-6">{{ form.prenom.label_tag }} {{ form.prenom }}</div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">{{ form.email.label_tag }} {{ form.email }}</div>
        <div class="col-md-6">{{ form.telephone.label_tag }} {{ form.telephone }}</div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">{{ form.date_naissance.label_tag }} {{ form.date_naissance }}</div>
        <div class="col-md-6">{{ form.formation.label_tag }} {{ form.formation }}</div>
      </div>

      <!-- ‚úÖ NOUVEAUX CHAMPS -->
      <div class="row mb-3">
        <div class="col-md-6">{{ form.commune.label_tag }} {{ form.commune }}</div>
        <div class="col-md-6">{{ form.quartier.label_tag }} {{ form.quartier }}</div>
      </div>

      <div class="mb-4">
        {{ form.message.label_tag }}
        {{ form.message }}
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-primary px-4">
          Voir le r√©capitulatif
        </button>
      </div>

    </form>
  </div>

</div>

<!-- ‚úÖ MODAL RECAP -->
<div class="modal fade" id="recapModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">R√©capitulatif de Pr√©inscription</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <p><strong>Nom :</strong> <span id="recapNom"></span></p>
        <p><strong>Pr√©nom :</strong> <span id="recapPrenom"></span></p>
        <p><strong>Email :</strong> <span id="recapEmail"></span></p>
        <p><strong>T√©l√©phone :</strong> <span id="recapTelephone"></span></p>
        <p><strong>Date de naissance :</strong> <span id="recapDateNaissance"></span></p>
        <p><strong>Formation :</strong> <span id="recapFormation"></span></p>

        <!-- ‚úÖ AJOUT√âS -->
        <p><strong>Commune :</strong> <span id="recapCommune"></span></p>
        <p><strong>Quartier :</strong> <span id="recapQuartier"></span></p>

        <p><strong>Message :</strong> <span id="recapMessage"></span></p>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-success" onclick="envoyerFormulaire()">
          ‚úÖ Confirmer l‚Äôenvoi
        </button>

        <button type="button" class="btn btn-primary" onclick="telechargerRecap()">
          üìÑ T√©l√©charger PDF
        </button>

        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Fermer
        </button>
      </div>

    </div>
  </div>
</div>

<script>

function showRecapModal(event) {
  event.preventDefault();

  recapNom.textContent = id_nom.value;
  recapPrenom.textContent = id_prenom.value;
  recapEmail.textContent = id_email.value;
  recapTelephone.textContent = id_telephone.value;
  recapDateNaissance.textContent = id_date_naissance.value;
  recapFormation.textContent = id_formation.value;
  recapCommune.textContent = id_commune.value;
  recapQuartier.textContent = id_quartier.value;
  recapMessage.textContent = id_message.value;

  new bootstrap.Modal(document.getElementById('recapModal')).show();
}

function envoyerFormulaire() {
  document.getElementById("preinscriptionForm").submit();
}

function telechargerRecap() {

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Fiche de Pr√©inscription", 20, 20);

  doc.setFontSize(12);
  doc.text("Nom : " + recapNom.textContent, 20, 40);
  doc.text("Pr√©nom : " + recapPrenom.textContent, 20, 50);
  doc.text("Email : " + recapEmail.textContent, 20, 60);
  doc.text("T√©l√©phone : " + recapTelephone.textContent, 20, 70);
  doc.text("Date de naissance : " + recapDateNaissance.textContent, 20, 80);
  doc.text("Formation : " + recapFormation.textContent, 20, 90);
  doc.text("Commune : " + recapCommune.textContent, 20, 100);
  doc.text("Quartier : " + recapQuartier.textContent, 20, 110);
  doc.text("Message : " + recapMessage.textContent, 20, 120);

  doc.save("recap_preinscription.pdf");
}

</script>

{% endblock %}
